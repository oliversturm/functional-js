SOURCES=presentation.md template/*

all: pdf html

present: 
	bs --verbose serve

present-impressive:
	# sudo apt install impressive
	@echo "Use mouse to highlight things"
	@echo "Return to spotlight, mouse wheel controls spotlight size"
	@echo "Tab for overview screen"
	@echo "Z for zoom in/out"
	@echo "Drag with right mouse button in zoom, just don't be too quick!"
	@echo "F toggles full-screen"
	@echo "Ctrl to navigate without transitions"
	@echo 'Use [ ] and { } keys to adjust gamma and black levels, 7 and 8 for highlight adjustment'
	# Using something like --fake-fullscreen -g 3840x2200 (where the height is a bit
	# higher than the actual screen) can make it possible to switch away from the 
	# presentation.
	impressive --fake-fullscreen --darkness 50 -q -T 500 -t Crossfade,FadeOutFadeIn,PagePeel,SlideDown,SlideLeft,SlideRight,SlideUp,SqueezeDown,SqueezeLeft,SqueezeRight,SqueezeUp,WipeBlobs,WipeBrightness1,WipeBrightness2,WipeCenterIn,WipeCenterOut,WipeClouds,WipeDown,WipeDownLeft,WipeDownRight,WipeLeft,WipeRight,WipeUp,WipeUpLeft,WipeUpRight slides.pdf

install-modules:
	npm install -g backslide

pdf: $(SOURCES)
	# A while back, this PDF export suddenly stopped working. Looking into the details,
	# the problem is that decktape reports a timeout when loading the HTML page (this is 
	# the pre-built HTML page, same as generated by the HTML export). With some presentations
	# I was able to work around this issue by including an image (go figure - one image
	# other than the one on the title slide did the trick), but now this doesn't seem to 
	# work anymore. 
	#bs --verbose pdf
	bs -s serve & echo "$$!" > .bs-serve.pid
	sleep 2

	# The assumption for this is that backslide is installed and has pulled down the 
	# decktape reference in its usual path.
	# The same PDF generation process seems to work correctly when using the served
	# HTML content instead of the generated one.
	node "$(NVM_PATH)_modules/backslide/node_modules/decktape/decktape.js" -p 1000 http://localhost:4100/presentation.html "pdf/presentation.pdf"

	cat .bs-serve.pid | xargs kill
	rm -f .bs-serve.pid

	ln -sf pdf/presentation.pdf ./slides.pdf
	# for backwards compatibility with old links
	ln -sf pdf/presentation.pdf ./slidecontent.pdf

html: $(SOURCES)
	bs --verbose export
	ln -sf dist/presentation.html ./index.html

output: 
	@echo $(SOURCES)
